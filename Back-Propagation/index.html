<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">    
    <title>Data Mining HW1</title>
    <link rel="stylesheet" type="text/css" href="css/normalize.css">
    <link rel="stylesheet" type="text/css" href="css/style.css">
</head>
<body>
	<div class="container">
	  	<div class="content">
	  		<canvas id="curveCanvas" width="510" height="310"  style="border:none;" ></canvas>
	  	</div>
	  	<div class="content">
	  	  	<label>
	  	  		資料選擇：
		  		<select id="dataSet">
		  			<option value="1">XOR</option>
		  			<option value="2">Iris</option>  			
		  		</select>
		  	</label>
	  	  	<label>
	  	  		訓練次數：
		  		<select id="trainTimes">
		  			<option value="1000">1000</option>
		  			<option value="2000">2000</option>  			
		  			<option value="5000">5000</option>  			
		  			<option value="10000">10000</option>  				  			
		  		</select>
		  	</label>
	  	  	<label>
	  	  		訓練比率：
		  		<select id="trainRate">
		  			<option value="0.1">0.1</option>
		  			<option value="0.3">0.3</option>  			
		  			<option value="0.5">0.5</option>  			
		  			<option value="1.0">1.0</option>  				  			
		  		</select>
		  	</label>
	  	  	<label>
	  	  		轉換函數：
		  		<select id="tranFunction">
		  			<option value="sigmoid">sigmoid</option>
		  			<option value="tanh">tanh</option>  			
		  		</select>
		  	</label>
	  	  	<label>
	  	  		隱藏層節點數量：
		  		<select id="numOfHidden">
		  			<option value="1">2*Ni+1</option>
		  			<option value="2">(Ni*No)^1/2</option>
		  			<option value="3">1/2*(Ni*No)</option>
		  		</select>
		  	</label>
		  	<button onclick="startToTrain();">開始訓練</button>
		  	<button>測試</button>

	  	</div>
	</div>
	<script>	//全域變數
		var BP = require('./BP.js');
		var bp = new BP();
		var errorRate = null;
	</script>
	<script>	//繪圖主函式
		function DescartesCanvas(){
			this.canvasId = null;
			this.canvas = null;
			this.ctx = null;
			this.canvasHeight = null;
			this.canvasWidth = null;

			this.init = function(canvasId){
				try{
					this.canvasId = canvasId;
					this.canvas = document.getElementById(this.canvasId);
					this.ctx = this.canvas.getContext('2d');
					this.canvasHeight = this.canvas.height - 10;
					this.canvasWidth = this.canvas.width - 10;
					this.ctx.clearRect(0, 0, this.canvas.height, this.canvas.width);
					this.basicLine();
					return true;
				}catch(e){
					return false;
				}
			}

			this.basicLine = function(){
				this.ctx.beginPath();
				this.ctx.moveTo(0, 0);
				this.ctx.lineTo(0, this.canvasHeight);
				this.ctx.lineTo(this.canvasWidth, this.canvasHeight);
				this.ctx.stroke();
			}

			this.draw = function(coordinate){
				this.ctx.moveTo(0, this.canvasHeight);
				for(var i=0;i<100;i++){
					//this.ctx.beginPath();
					//this.ctx.moveTo( i*parseInt((this.canvasWidth/100)), 25);
					var x_axis = i*parseInt((this.canvasWidth/100));
					var y_axis = (1-coordinate[i*parseInt((coordinate.length/100))])*100*parseInt((this.canvasHeight/100));
					y_axis = (y_axis!=this.canvasHeight)?y_axis:y_axis-2;
					this.ctx.fillRect(x_axis, y_axis,4,4);
				}

			}
		}

	</script>
	<script> //get elements values and start to train
		function startToTrain(){
			var getHtmlTag = function(id){
				return document.getElementById(id);
			}
			var dataSet = getHtmlTag('dataSet').value;
			var trainTimes = parseInt(getHtmlTag('trainTimes').value);
			var trainRate = parseFloat(getHtmlTag('trainRate').value);
			var tranFunction = getHtmlTag('tranFunction').value;
			var numOfHidden = getHtmlTag('numOfHidden').value;
			//document.write("<script src='xorSetting.js'><script>");
			var inputData = null;
			var ni = 0;
			var nh = 0;
			var no = 0;
			var tranf = '';
			var dTranf = '';
			console.log(dataSet);
			switch(dataSet){
				case '1':
					ni = 2;
					no = 1;
					inputData = [
								  [[0,0], [0]],
								  [[0,1], [1]],
								  [[1,0], [1]],
								  [[1,1], [0]]
								];
					console.log('xor 資料設定成功');
					break;
				case '2':
					ni = 4;
					no = 3;	//no=1 => no=3 因為輸出表達方式從字串轉成陣列(ex:Iris-setosa => [0, 0, 1])
					var fs = require('fs');
					var array = fs.readFileSync('iris.data.txt').toString().split("\n");  //同步讀檔
					var inputData = new Array(array.length);
					for(var i=0;i<array.length;i++){
					    inputData[i] = new Array(2);
					    inputData[i][0] = new Array(ni);
					    inputData[i][1] = new Array(no);
					}
					for(i in array) {
					    var tempArray = array[i].toString().split(',');
					    for(var k=0;k<tempArray.length;k++){
					        if(k==tempArray.length-1){
					            inputData[i][1][0] = tempArray[k];
					        }else {
					            inputData[i][0][k] = tempArray[k];
					        }
					    }
					    switch(inputData[i][1][0]){
					        case 'Iris-setosa':
					            inputData[i][1] = [0, 0, 1];
					            break;
					        case 'Iris-versicolor':
					            inputData[i][1] = [0, 1, 0];           
					            break;
					        case 'Iris-virginica':
					            inputData[i][1] = [1, 0, 0];           
					            break;
					    }
					}
					console.log('Iris 資料設定成功');
					break;
			}
			switch(numOfHidden){
				case '1':
					nh = 2*ni + 1;
					break;
				case '2':
					nh = Math.pow(ni*no, 0.5);
					break;
				case '3':
					nh = 0.5*(ni*no);
					break;
			}

			switch(tranFunction){
				case 'sigmoid':
					tranf = 'sigmoid';
					dTranf = 'dSigmoid';
					break;
				case 'tanh':
					tranf = 'tanh';
					dTranf = 'dTanh';
					break;
			}


			bp.init(ni, nh, no);
			errorRate = bp.train(inputData, trainTimes, trainRate, 0.1, tranf, dTranf);
			var recallErrorRate = bp.recall(inputData, tranf);




			var d = new DescartesCanvas();
	  		var flag = d.init('curveCanvas');
	  		d.draw(errorRate);


		}
	</script>	  		  
</body>
</html>
